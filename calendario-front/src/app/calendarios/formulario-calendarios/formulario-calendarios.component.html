
<mat-card>
  <mat-card-header>
    <mat-card-title>{{ tituloFormulario }}</mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="form" (ngSubmit)="guardar()" autocomplete="off">
<!-- 
      <pre>{{ form.status }} | touched: {{ form.touched }} | dirty: {{ form.dirty }}</pre>
      <ul>
        <li *ngFor="let c of form.controls | keyvalue">
          {{ c.key }} => status: {{ c.value.status }} | value: {{ c.value.value }} | errors: {{ c.value.errors | json }}
        </li>
      </ul> -->

      <div class="form-grid">

        <!-- Rectoria -->
        <mat-form-field appearance="outline">
          <mat-label>Rectoría</mat-label>
          <mat-select formControlName="id_rectoria">
            <mat-option *ngFor="let rectoria of rectorias; trackBy: rectoriaTrackBy" [value]="rectoria.id_rectoria">
              {{ rectoria.nombre_rectoria }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('id_rectoria')?.hasError('required')">
            La rectoría es obligatoria.
          </mat-error>
        </mat-form-field>

        <!-- Sede -->
        <mat-form-field appearance="outline">
          <mat-label>Sede</mat-label>
          <mat-select formControlName="id_sede">
            <mat-option *ngFor="let sede of sedes; trackBy: sedeTrackBy" [value]="sede.id">
              {{ sede.nombre }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('id_rectoria')?.hasError('required')">
            Antes de seleccionar una sede, debes seleccionar una rectoría. 
          </mat-error>
          <mat-error *ngIf="form.get('id_sede')?.hasError('required')">
            La sede es obligatoria.
          </mat-error>
        </mat-form-field>

        <!-- Modalidad -->
        <mat-form-field appearance="outline">
          <mat-label>Modalidad</mat-label>
          <mat-select formControlName="id_modalidad">
            <mat-option *ngFor="let modalidad of modalidades; trackBy: modalidadTrackBy" 
                        [value]="modalidad.id">
              {{ modalidad.nombre }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('id_modalidad')?.hasError('required')">
            La modalidad es obligatoria.
          </mat-error>
        </mat-form-field>

        <!-- Tipo de Periodo -->
        <mat-form-field appearance="outline">
          <mat-label>Tipo de Periodo</mat-label>
          <mat-select formControlName="id_tipo_periodo">
            <mat-option *ngFor="let tipo of tiposPeriodo; trackBy: tipoPeriodoTrackBy" [value]="tipo.id">
              {{ tipo.nombre }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('id_tipo_periodo')?.hasError('required')">
            El tipo de periodo es obligatorio.
          </mat-error>
        </mat-form-field>

        <!-- Periodo Académico -->
        <mat-form-field appearance="outline">
          <mat-label>Periodo Académico</mat-label>
          <mat-select formControlName="id_periodo_academico">
            <mat-option *ngFor="let periodo of periodos; trackBy: periodoTrackBy" [value]="periodo.id">
              {{ periodo.anio }} - {{ periodo.periodo }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('id_periodo_academico')?.hasError('required')">
            El periodo académico es obligatorio.
          </mat-error>
        </mat-form-field>

        <!-- En sede -->
       <mat-form-field appearance="outline">
        <mat-label>¿En sede?</mat-label>
        <mat-select formControlName="en_sede">
          <mat-option [value]="1">Sí</mat-option>
          <mat-option [value]="0">No</mat-option>
        </mat-select>
       </mat-form-field>

      </div>



      <!-- Acciones -->
      <div class="acciones">
        <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid">
          Guardar
        </button>
        <button mat-raised-button class="boton-cancelar" type="button" (click)="cancelar()">Cancelar</button>
      </div>

      <hr />

      <!-- ACTIVIDADES -->
      <div formArrayName="actividades">
        <div
          *ngFor="let actividad of actividades.controls; let i = index; trackBy: actividadTrackBy"
          [formGroupName]="i"
          class="actividad"
        >
          <h3>
            Actividad {{ i + 1 }}
            <button mat-icon-button color="warn" type="button" (click)="eliminarActividad(i)">
              <mat-icon>delete</mat-icon>
            </button>
          </h3>

          <mat-form-field appearance="outline">
            <mat-label>Título de la Actividad</mat-label>
            <input matInput formControlName="titulo" />
            <mat-error *ngIf="actividad.get('titulo')?.hasError('required')">
              El título es obligatorio.
            </mat-error>
            <mat-error *ngIf="actividad.get('titulo')?.hasError('maxlength')">
              Máximo 254 caracteres.
            </mat-error>
            <mat-error *ngIf="actividad.get('titulo')?.hasError('soloEspacios')">
              No puede contener solo espacios.
            </mat-error>
          </mat-form-field>

          <!-- SUBACTIVIDADES -->
          <div formArrayName="subactividades" class="subactividades">
            <div
              *ngFor="let sub of getSubactividades(i).controls; let j = index; trackBy: subactividadTrackBy"
              [formGroupName]="j"
              class="subactividad"
            >
              <h4>
                Subactividad {{ j + 1 }}
                <button mat-icon-button color="warn" type="button"
                        (click)="eliminarSubactividad(i, j)">
                  <mat-icon>delete</mat-icon>
                </button>
              </h4>

              <div class="sub-grid">
                
                <mat-form-field appearance="outline">
                  <mat-label>Fecha Inicio</mat-label>
                  <input matInput [matDatepicker]="pickerIni" formControlName="fecha_inicio" />
                  <mat-datepicker-toggle matSuffix [for]="pickerIni"></mat-datepicker-toggle>
                  <mat-datepicker #pickerIni></mat-datepicker>
                  <mat-error *ngIf="sub.get('fecha_inicio')?.hasError('fechaPasada')">
                    La fecha de inicio no puede ser menor a la fecha actual.
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Fecha Fin</mat-label>
                  <input matInput [matDatepicker]="pickerFin" formControlName="fecha_fin" />
                  <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
                  <mat-datepicker #pickerFin></mat-datepicker>

                  <!-- Mensajes -->
                  <mat-error *ngIf="sub.get('fecha_fin')?.hasError('fechaPasada')">
                    La fecha Fin no puede ser menor a la fecha actual.
                  </mat-error>
                  <mat-error *ngIf="sub.get('fecha_fin')?.hasError('finAntesInicio')">
                    La fecha Fin no puede ser anterior a la fecha de inicio.
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="nombre">
                  <mat-label>Nombre</mat-label>
                  <input matInput formControlName="nombre" />
                  <mat-error *ngIf="sub.get('nombre')?.hasError('required')">
                    El nombre es obligatorio.
                  </mat-error>
                  <mat-error *ngIf="sub.get('nombre')?.hasError('maxlength')">
                    Máximo 254 caracteres.
                  </mat-error>
                  <mat-error *ngIf="sub.get('nombre')?.hasError('soloEspacios')">
                    No puede contener solo espacios.
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="descripcion">
                  <mat-label>Descripción</mat-label>
                  <textarea matInput formControlName="descripcion"></textarea>
                  <mat-error *ngIf="sub.get('descripcion')?.hasError('maxlength')">
                    Máximo 254 caracteres.
                  </mat-error>
                </mat-form-field>

              </div>
            </div>

            <button mat-stroked-button color="primary" type="button" (click)="agregarSubactividad(i)">
              <mat-icon>add</mat-icon> Agregar Subactividad
            </button>
          </div>

          <hr />
        </div>

        <div class="agregar-actividad">
          <button mat-raised-button color="accent" type="button" (click)="agregarActividad()">
            <mat-icon>add</mat-icon> Agregar Actividad
          </button>
        </div>
      </div>
    </form>
  </mat-card-content>
</mat-card>
